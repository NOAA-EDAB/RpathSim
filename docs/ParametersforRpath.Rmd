---
title: "Summary of Parameters for Rpath"
author: "Sarah Gaichas"
date: "`r Sys.Date()`"
output:
  html_document:
    code_fold: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(here)
library(tidyverse)  
library(atlantisom)
library(ggthemes)

```

## Species in Atlantis for Rpath

The full species list from Atlantis, with group type and whether it is fished.

```{r}

localatlantisdir <- "/Users/sarah.gaichas/Documents/0_Data/ms-keyrun/simulated-data/atlantisoutput/NOBA_sacc_38"

fwspp <- atlantisom::load_fgs(localatlantisdir, "nordic_groups_v04.csv") %>% 
  dplyr::filter(IsTurnedOn == 1) %>%
  dplyr::select(Code, Name, Long.Name, NumCohorts, isFished, InvertType) 

knitr::kable(fwspp)

```


## Total Catch

Already in `mskeyrun` (sarah_wgsamsim branch)? Yes. 

Plot it. Turns out even though mammals can be caught, they are not in the catch output so probably not in this run. The catch we have added here in addition to the main `mskeyrun` data is Prawns, Redfish other, and Snow crabs (which appear to have 0 catch).

```{r}
# make sure to install mskeyrun branch sarah_wgsamsim as not yet in main branch

# make a catch series function that can be split by fleet? this doesnt
# also note different time (days) from model timestep in all other output
plotC <- function(dat, truedat=NULL){
  
    ctbio <- dat %>% filter(variable=="catch")
    ctcv <- dat %>% filter(variable=="cv")
  
    ggplot() +
    geom_line(data=ctbio, aes(x=year,y=value, color="Catch biomass"), 
              alpha = 10/10) +
    {if(!is.null(truedat)) geom_line(data=truedat, aes(x=time/365,y=atoutput, color="True Catch"), alpha = 3/10)} + 
    theme_tufte() +
    theme(legend.position = "top") +
    xlab("model year") +
    ylab("tons") +
    labs(colour=dat$ModSim) +
    facet_wrap(~Name, scales="free") 
  
}

catchbio_ss <- mskeyrun::simCatchIndexFW #atlantisom::read_savedfisheries(d.name, 'Catch')  
```

### Fishery catch time series
```{r catchind-1, results="asis", message=FALSE, warning=FALSE}
# observed catch only
plotC(catchbio_ss)
```

### Fishery catch subannual
```{r catchind-2, results="asis", message=FALSE, warning=FALSE}

catchbio_sub <- mskeyrun::simCatchIndexSubannualFW

# observed catch only
plotC(catchbio_sub)
```



## Total Biomass

Update: working now for all groups.

Available for age structured fish groups, other age structured groups, and biomass pools:

```{r}
# plot biomass time series facet wrapped by species
plotB <- function(dat, truedat=NULL){
  
    svbio <- dat %>% filter(variable=="biomass")
    svcv <- dat %>% filter(variable=="cv")
  
    ggplot() +
    geom_line(data=svbio, aes(x=year,y=value, color="Survey Biomass"), 
              alpha = 10/10) +
    {if(!is.null(truedat)) geom_line(data=truedat, aes(x=time/365,y=atoutput, color="True B"), alpha = 3/10)} + 
    theme_tufte() +
    theme(legend.position = "top") +
    xlab("model year") +
    ylab("tons") +
    labs(colour=dat$ModSim) +
    facet_wrap(~Name, scales="free") 
  
}

survObsBiom <- mskeyrun::simSurveyIndexFW #atlantisom::read_savedsurvs(d.name, 'survB')

```

### Survey biomass index {.tabset}
```{r, results="asis", fig.width=10, fig.asp=1}

# compare with true output (all timesteps)
# for(s in names(survObsBiom)){
#   cat("  \n##### ",  s,"  \n")
#   print(plotB(survObsBiom[[s]][[1]], omlist_ss$truetotbio_ss))
#   cat("  \n")
# }

# plots survey only
 for(s in unique(survObsBiom$survey)){
   cat("  \n#### ",  s,"  \n")
   print(plotB(survObsBiom %>%
                 filter((survey %in% s))))
   cat("  \n")
 }

```

### {-}

Biomass pools added to workflow in` atlantisom::run_truth`, `atlantisom::om_species`, and `atlantisom::om_index`, new surveys generated in `mskeyrun` SimData vignette, new datasets generated with `mskeyrun::create_sim_survey_index_fw`.

## Diets for all

Did I pull this? No.

## Total Production 

Can we get total production from Atlantis? What is in PROD.nc

Or do we need to sum the catch and consumption removals with the population growth in each year to get production



## Total Consumption

Already have this from detailed diet check



